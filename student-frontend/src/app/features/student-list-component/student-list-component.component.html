<div class="row mb-3">
  <div class="row align-items-end mb-3">
  <div class="col-md-6 mb-2 mb-md-0">
    <input
      type="text"
      class="form-control"
      placeholder="Search by name, email or mobile..."
      [(ngModel)]="searchQuery"
      (ngModelChange)="onSearchChange()"
    />
  </div>

  <div class="col-auto">
    <label class="col-form-label">Filter by Course:</label>
  </div>

  <div class="col-md-4">
    <select
      class="form-select"
      [(ngModel)]="selectedCourse"
      (change)="onFilterChange()"
    >
      <option [ngValue]="null" >
        -- Filter by course --
      </option>
      <option
        *ngFor="let course of courseOptions"
        [ngValue]="course.value"
      >
        {{ course.label }}
      </option>
    </select>
  </div>
</div>

  
  <div *ngIf="selectedCourse || searchQuery" class="col-12 mt-2">
    <strong>Filter Result:</strong>
    <span class="badge bg-primary ms-2">{{ totalStudents }} students found</span>
  </div>
</div>

<app-alert></app-alert>
<div *ngIf="isLoading" class="text-center p-5">
  <div class="spinner-border" role="status">
    <span class="visually-hidden">Loading...</span>
  </div>
</div>

<div *ngIf="!isLoading" class="table-responsive">
  <table class="table table-striped table-bordered table-hover align-middle">
    <thead>
      <tr>
        <th>#</th>
        <th>
          Name
          <button class="btn btn-light btn-sm ms-2 p-1" (click)="onSortClick()">
            <lucide-icon [name]="isSortedAsc ? 'a-arrow-down' : 'a-arrow-up'" size="16"></lucide-icon>
          </button>
        </th>
        <th>Course</th>
        <th>Email</th>
        <th>Mobile</th>
        <th>Add & Edit Date</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let s of students; let i = index">
        <td>{{ (currentPage - 1) * itemsPerPage + i + 1 }}</td>
        <td>

          <div class="d-flex align-items-center">
            <ng-container *ngIf="s.image?.data; else DummyIcon">
              <img alt="Student Image" class="rounded-circle me-2"
                style="width: 30px; height: 30px; object-fit: cover; cursor: pointer;"
                [src]="changeImagFormat(s.image.data)" (click)="openImageModal(imageModal, s)" />
            </ng-container>

            <ng-template #DummyIcon>
              <lucide-icon name="user" color="#367dbf" style="width: 30px; height: 30px; cursor: pointer;"
                class="rounded-circle me-2" (click)="openImageModal(imageModal, s)"></lucide-icon>
            </ng-template>

            <span>{{ s.name }}</span>
          </div>
        </td>
        <td>
          {{ s.course }}
          <lucide-icon *ngIf="!s.isActive" name="ban" class="text-danger ms-1" size="16"></lucide-icon>
        </td>
        <td>{{ s.email }}</td>
        <td>{{ s.mobile }}</td>
        <td>
          <div class="d-flex flex-column small">
            <span>{{formatDate(s.added_at) }}</span>
            <span class="text-muted">{{formatDate(s.edited_at) }}</span>
          </div>
        </td>
        <td>
          <button class="btn btn-link p-1 me-2" (click)="navigateToEdit(s.email)">
            <lucide-icon name="pencil-line" size="18" class="text-primary"></lucide-icon>
          </button>
          <button class="btn btn-link p-1" (click)="openDeleteModal(deleteModal, s)">
            <lucide-icon name="trash-2" size="18" class="text-danger"></lucide-icon>
          </button>
        </td>
      </tr>
      <tr *ngIf="students.length === 0">
        <td colspan="7" class="text-center text-muted">No students found.</td>
      </tr>
    </tbody>
  </table>
</div>

<div *ngIf="!isLoading && totalPages > 1" class="d-flex justify-content-center mt-3">
  <ngb-pagination [collectionSize]="totalStudents" [(page)]="currentPage" [pageSize]="itemsPerPage" [maxSize]="5"
    [rotate]="true" [boundaryLinks]="true" (pageChange)="onPageChange($event)">
  </ngb-pagination>
</div>


<ng-template #deleteModal let-modal>
  <div class="modal-header">
    <h4 class="modal-title">Confirm Deletion</h4>
    <button type="button" class="btn-close" aria-label="Close" (click)="modal.dismiss('Cross click')"></button>
  </div>
  <div class="modal-body">
    <p>Are you sure you want to delete <strong>{{ studentToDelete?.name }}</strong>?</p>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-secondary" (click)="modal.dismiss('cancel click')">Cancel</button>
    <button type="button" class="btn btn-danger" (click)="modal.close('delete')">Delete</button>
  </div>
</ng-template>


<ng-template #imageModal let-modal>
  <div class="modal-header">
    <h4 class="modal-title">Student Image</h4>
    <button type="button" class="btn-close" (click)="modal.dismiss()"></button>
  </div>
  <div class="modal-body text-center">
    <img [src]="enlargedImageUrl" alt="Enlarged student" class="img-fluid" style="max-height: 70vh;">
  </div>
</ng-template>